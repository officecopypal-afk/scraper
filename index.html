<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audyteko SDR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }

        .loader {
            border-top-color: #6ff17c;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>

<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-[#1f2937] rounded-2xl shadow-2xl shadow-black/30 overflow-hidden">
        <header class="p-6 bg-gray-900/50 border-b border-gray-700/50">
            <h1 class="text-2xl font-bold text-white">Audyteko SDR</h1>
            <p class="text-sm text-gray-400 mt-1">Automatyzacja kontaktu z agencjami na Otodom</p>
        </header>

        <main class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Panel Konfiguracyjny -->
            <div id="config-panel" class="bg-gray-900/50 p-6 rounded-xl border border-gray-700/50">
                <h2 class="text-lg font-semibold text-white mb-4">Konfiguracja</h2>
                <div class="space-y-4">
                    <div>
                        <label for="otodom-url" class="block text-sm font-medium text-gray-300 mb-1">Link do wyników wyszukiwania</label>
                        <input type="url" id="otodom-url" value="https://www.otodom.pl/pl/wyniki/sprzedaz/mieszkanie/cala-polska?limit=24&market=SECONDARY&ownerTypeSingleSelect=AGENCY&by=LATEST&direction=DESC&viewType=listing"
                            class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#6ff17c] focus:border-[#6ff17c] transition">
                    </div>
                     <div>
                        <label for="page-count" class="block text-sm font-medium text-gray-300 mb-1">Liczba stron do przetworzenia</label>
                        <input type="number" id="page-count" value="1" min="1" max="50"
                            class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#6ff17c] focus:border-[#6ff17c] transition">
                    </div>
                    <div>
                        <label for="user-name" class="block text-sm font-medium text-gray-300 mb-1">Twoje Imię</label>
                        <input type="text" id="user-name" value="Emil"
                            class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#6ff17c] focus:border-[#6ff17c] transition">
                    </div>
                    <div>
                        <label for="user-email" class="block text-sm font-medium text-gray-300 mb-1">Twój Email</label>
                        <input type="email" id="user-email" value="emil@audyteko.eu"
                            class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#6ff17c] focus:border-[#6ff17c] transition">
                    </div>
                    <div>
                        <label for="user-phone" class="block text-sm font-medium text-gray-300 mb-1">Twój Telefon</label>
                        <input type="tel" id="user-phone" value="573580435"
                            class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#6ff17c] focus:border-[#6ff17c] transition">
                    </div>
                    <div>
                        <label for="message-template" class="block text-sm font-medium text-gray-300 mb-1">Szablon Wiadomości</label>
                        <textarea id="message-template" rows="8"
                            class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#6ff17c] focus:border-[#6ff17c] transition">Dzień dobry, 
Zapraszam do skorzystania z oferty na świadectwo energetyczne dla tego mieszkania w super cenie 149 zł brutto  – wszystkie sprawy techniczne bierzemy na siebie, całą procedurę maksymalnie upraszczamy :)

Zamówienie można złożyć bezpośrednio przez nasz formularz na stronie: www.audyteko.eu
Zapraszam do sprawdzenia nas oraz przetestowania naszej oferty dla agencji nieruchomości! :)
Pozdrawiam,
Emil
www.audyteko.eu</textarea>
                    </div>
                </div>
                 <div class="mt-6 flex space-x-4">
                    <button id="start-btn" class="w-full bg-[#6ff17c] text-gray-900 font-bold py-2 px-4 rounded-md hover:bg-green-400 transition duration-300 flex items-center justify-center">
                        Start
                    </button>
                    <button id="stop-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-500 transition duration-300 disabled:bg-gray-700 disabled:cursor-not-allowed" disabled>
                        Stop
                    </button>
                </div>
            </div>

            <!-- Panel Postępu -->
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700/50 flex flex-col">
                <h2 class="text-lg font-semibold text-white mb-4">Postęp</h2>
                <div id="status-container" class="mb-4 p-3 bg-gray-800 rounded-md text-center text-sm">
                    Oczekiwanie na rozpoczęcie...
                </div>
                <div id="log-container" class="flex-grow bg-gray-800 rounded-md p-4 overflow-y-auto h-96 text-sm">
                    <!-- Logi będą dodawane tutaj -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const urlInput = document.getElementById('otodom-url');
        const pageCountInput = document.getElementById('page-count');
        const nameInput = document.getElementById('user-name');
        const emailInput = document.getElementById('user-email');
        const phoneInput = document.getElementById('user-phone');
        const messageInput = document.getElementById('message-template');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusContainer = document.getElementById('status-container');
        const logContainer = document.getElementById('log-container');

        // UWAGA: Pamiętaj, aby podmienić ten link na Twój prawdziwy adres z Netlify!
        const scraperUrl = 'https://ephemeral-kitsune-9be704.netlify.app/.netlify/functions/scrape';

        let isRunning = false;
        let processedContacts = new Set();
        let totalAds = 0;
        let processedAds = 0;

        function setUIState(running) {
            isRunning = running;
            startBtn.disabled = running;
            stopBtn.disabled = !running;
            urlInput.disabled = running;
            pageCountInput.disabled = running;
            nameInput.disabled = running;
            emailInput.disabled = running;
            phoneInput.disabled = running;
            messageInput.disabled = running;
        }

        function updateStatus(message, isError = false) {
             const statusClass = isError ? 'text-red-400' : 'text-gray-300';
             statusContainer.innerHTML = `<span class="${statusClass}">${message}</span>`;
        }

        function logMessage(message, type = 'info') {
            const colors = {
                info: 'text-gray-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
            };
            const logEntry = document.createElement('div');
            logEntry.className = `p-2 mb-2 rounded-md bg-gray-900/50 ${colors[type]}`;
            logEntry.innerHTML = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function fetchFromScraper(body) {
             const response = await fetch(scraperUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                // Now we get more details from the response body if it's a 500 error
                 if (response.status === 500) {
                    const errorData = await response.json();
                    throw new Error(`Błąd serwera (500): ${errorData.error || 'Nieznany błąd scrapera'}`);
                }
                throw new Error(`Błąd sieciowy: ${response.status} ${response.statusText}`);
            }
            return response.json();
        }

        startBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            const totalPages = parseInt(pageCountInput.value, 10);
            if (!url) {
                logMessage('Błąd: Wprowadź link do wyników wyszukiwania.', 'error');
                return;
            }

            setUIState(true);
            logContainer.innerHTML = '';
            processedContacts.clear();
            totalAds = 0;
            processedAds = 0;

            try {
                for (let currentPage = 1; currentPage <= totalPages; currentPage++) {
                    if (!isRunning) break;

                    updateStatus(`Strona ${currentPage}/${totalPages} - Pobieranie linków...`);
                    
                    const pageUrl = `${url}&page=${currentPage}`;
                    const { links } = await fetchFromScraper({ action: 'getLinks', url: pageUrl });
                    
                    if (!links || links.length === 0) {
                        logMessage(`Strona ${currentPage}: Nie znaleziono żadnych ogłoszeń.`, 'warning');
                        continue;
                    }

                    totalAds += links.length;
                    logMessage(`Strona ${currentPage}: Znaleziono ${links.length} ogłoszeń. Rozpoczynam przetwarzanie...`, 'info');

                    for (const adLink of links) {
                        if (!isRunning) break;
                        processedAds++;
                        updateStatus(`Strona ${currentPage}/${totalPages} - Przetwarzanie ogłoszenia ${processedAds}/${totalAds}...`);

                        const result = await fetchFromScraper({
                            action: 'processAd',
                            url: adLink,
                            formData: {
                                name: nameInput.value,
                                email: emailInput.value,
                                phone: phoneInput.value,
                                message: messageInput.value
                            },
                            processedContacts: Array.from(processedContacts)
                        });

                        const contactKey = `${result.userName}-${result.userPhone}`;

                        if (result.status === 'skipped') {
                             logMessage(`POMINIĘTO (Duplikat): <strong>${result.userName || 'Brak nazwy'}</strong> (${result.userPhone || 'Brak telefonu'})`, 'warning');
                        } else if (result.status === 'success') {
                            processedContacts.add(contactKey);
                            logMessage(`WYSŁANO: Wiadomość do <strong>${result.userName}</strong> (${result.userPhone})`, 'success');
                        } else {
                            // This is the new part for detailed errors
                            logMessage(`BŁĄD przy ogłoszeniu dla <strong>${result.userName || 'Nieznany'}</strong>: <br><small>${result.error}</small>`, 'error');
                        }
                        await delay(1000); // Small delay between requests
                    }
                }

                if (isRunning) {
                     updateStatus('Zakończono! Przetworzono wszystkie zadania.');
                } else {
                     updateStatus('Zatrzymano przez użytkownika.');
                }

            } catch (error) {
                updateStatus(`Krytyczny błąd procesu: ${error.message}`, true);
                logMessage(`Wystąpił krytyczny błąd: ${error.message}`, 'error');
            } finally {
                setUIState(false);
            }
        });

        stopBtn.addEventListener('click', () => {
            if (isRunning) {
                setUIState(false);
                updateStatus('Zatrzymywanie...');
            }
        });

    </script>
</body>

</html>

